<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TrueTrend AI — Learn money. Earn money. Own money.</title>
  <meta name="description" content="TrueTrend AI reads charts, explains the why, and tells you what’s changing—so you can act with confidence."/>
  <style>
    :root{
      --bg:#070b14;--ink:#ecf1ff;--mut:#97a5c7;--card:#0d1324;--line:#1a2340;
      --acc:#22c55e;--acc2:#7c5cff;--chip:#111a33;--glow:0 12px 30px rgba(124,92,255,.25);
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:linear-gradient(180deg,#070b14 0%,#0a1130 100%);color:var(--ink);font:16px/1.45 Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial}
    a{color:#9cc1ff;text-decoration:none}
    .wrap{max-width:1200px;margin:0 auto;padding:28px}
    header{display:flex;align-items:center;justify-content:space-between;gap:14px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(45deg,var(--acc2),#36d399);box-shadow:0 0 18px #7c5cff}
    nav a{margin:0 10px;color:var(--mut)}
    .cta{display:flex;gap:10px;flex-wrap:wrap}
    .btn{background:var(--acc);color:#062613;border:0;padding:12px 18px;border-radius:12px;font-weight:800;cursor:pointer}
    .btn.ghost{background:#121a33;color:#cfe0ff;border:1px solid var(--line)}
    .btn.purple{background:var(--acc2);color:#0a0720;box-shadow:var(--glow)}
    .tag{display:inline-block;background:#0c1530;border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:#cde1ff;margin:4px 6px 0 0;font-size:.86rem}
    .grid{display:grid;gap:24px;grid-template-columns:1.1fr 1fr;margin-top:26px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:20px}
    h1{font-size:44px;line-height:1.05;margin:10px 0}
    .sub{color:var(--mut)}
    .badges{margin-top:12px}
    .lockable{position:relative}
    .lockOverlay{position:absolute;inset:0;background:linear-gradient(0deg,rgba(8,12,24,.7),rgba(8,12,24,.7));display:flex;align-items:center;justify-content:center;border-radius:18px}
    .lockInner{background:#0b1222;border:1px solid var(--line);padding:16px;border-radius:12px;text-align:center}
    input,select,textarea{background:#0b1430;border:1px solid var(--line);color:var(--ink);border-radius:12px;padding:11px 12px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:#0f1a3a;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .mut{color:var(--mut)}
    .mono{font-family:ui-monospace,Consolas,Menlo,monospace}
    .kpi{font-size:40px;font-weight:900}
    .divider{height:1px;background:var(--line);margin:18px 0}
    .modal{position:fixed;inset:0;background:rgba(2,4,10,.6);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal .sheet{max-width:900px;width:100%;background:#0d1326;border:1px solid var(--line);border-radius:16px;padding:18px}
    footer{margin:50px 0 20px;color:var(--mut);text-align:center}
    canvas{max-width:100%}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <span class="dot"></span>
        <strong>TrueTrend AI</strong>
        <span id="planBadge" class="tag">Checking plan…</span>
      </div>
      <nav>
        <a href="#strategies">Strategies</a>
        <a href="#pricing">Pricing</a>
        <a href="#" id="openGuide">How-to</a>
      </nav>
      <div class="cta">
        <a class="btn purple" href="#pricing">Start 3-Day Free Trial</a>
      </div>
    </header>

    <section class="grid">
      <div class="card">
        <h1>Learn money. Earn money. Own money.</h1>
        <p class="sub">Your chic AI co-pilot that reads <b>any chart</b>, explains the <b>why</b>, and tells you what’s changing—so you can act with confidence.</p>
        <div class="badges">
          <div class="mut" style="margin:6px 0 2px">Works with charts:</div>
          <span class="tag">TradingView</span><span class="tag">TD</span><span class="tag">Webull</span><span class="tag">MooMoo</span><span class="tag">MT4/5</span><span class="tag">ThinkOrSwim</span>
          <div class="mut" style="margin:10px 0 2px">And brokers/exchanges:</div>
          <span class="tag">Schwab</span><span class="tag">Fidelity</span><span class="tag">OANDA (FX)</span><span class="tag">Binance</span>
        </div>

        <div class="divider"></div>
        <div class="row">
          <a class="btn" href="#pricing">Try 3-Day Free</a>
          <button class="btn ghost" id="openStrategies">See Strategies & How-To</button>
        </div>
      </div>

      <div class="card lockable" id="proPanel">
        <div class="row" style="justify-content:space-between">
          <h3 style="margin:0">Analyzer (Pro/Lifetime)</h3>
          <div class="pill" id="otState">Over-trading: <b id="otLabel">Cool</b></div>
        </div>

        <div class="row" style="margin-top:12px">
          <input id="symbol" placeholder="Ticker e.g. NVDA, EURUSD, BTCUSD" style="flex:1"/>
          <select id="timeframe">
            <option value="15m">15m</option><option value="1h">1h</option><option value="4h">4h</option>
            <option value="Daily" selected>Daily</option><option value="Weekly">Weekly</option>
          </select>
          <select id="strategy">
            <option value="trendline">Trendline (short-term)</option>
            <option value="cross">Crossing EMAs (swing)</option>
            <option value="rsiReversal">RSI Reversal (short-term)</option>
            <option value="breakout">Range Breakout (any)</option>
          </select>
          <button class="btn" id="run">Analyze</button>
        </div>

        <pre id="answer" class="mono" style="margin-top:12px;white-space:pre-wrap"></pre>

        <div id="voiceRow" class="row" style="margin-top:6px;display:none">
          <button class="btn ghost" id="speakBtn">🔊 Read it to me</button>
          <span class="mut">Friendlier male voice.</span>
        </div>
      </div>
    </section>

    <section class="grid" style="margin-top:24px">
      <div class="card">
        <h3>Trade Journal & Equity Curve</h3>
        <p class="mut">Basic, Pro, and Lifetime all get journaling. Log entries, exits, result and reasons. We’ll draw your equity curve.</p>
        <div class="row" style="gap:8px;margin:6px 0">
          <input id="jSym" placeholder="Symbol" style="width:120px">
          <input id="jEntry" type="number" step="0.0001" placeholder="Entry">
          <input id="jExit" type="number" step="0.0001" placeholder="Exit">
          <select id="jSide"><option>BUY</option><option>SELL</option></select>
          <input id="jNotes" placeholder="Why did you win/lose?">
          <button class="btn" id="addJ">Add</button>
        </div>
        <canvas id="equity" height="120"></canvas>
        <div class="divider"></div>
        <table id="jTable" style="width:100%;border-collapse:collapse;font-size:.95rem">
          <thead><tr style="color:#c6d6ff"><th align="left">Date</th><th align="left">Symbol</th><th>Side</th><th>Entry</th><th>Exit</th><th>P/L</th><th align="left">Notes</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h3>Voice lookup (Pro/Lifetime)</h3>
        <p class="mut">Ask TrueTrend for a ticker and it’ll summarize. This is Pro/Lifetime only.</p>
        <div class="row">
          <input id="voiceSym" placeholder="AAPL, NVDA, EURUSD"/>
          <button class="btn" id="voiceAnalyze">Get voice text</button>
        </div>
        <pre id="voiceOut" class="mono" style="margin-top:10px;white-space:pre-wrap"></pre>
      </div>
    </section>

    <section id="pricing" class="card" style="margin-top:30px">
      <h3>Pricing</h3>
      <div class="row" style="flex-wrap:wrap;gap:16px">
        <div class="card" style="min-width:260px">
          <h4>Basic — $59.99/mo</h4>
          <ul class="mut">
            <li>Chart reading on any chart you open</li>
            <li>Journal + Equity Curve</li>
            <li>Over-trading guard</li>
          </ul>
          <a class="btn" href="https://buy.stripe.com/fZueVd0nPgU4dzvfkW38401">Start 3-Day Free</a>
        </div>
        <div class="card" style="min-width:260px;border-color:#7c5cff;box-shadow:var(--glow)">
          <h4>Pro — $99.99/mo</h4>
          <ul class="mut">
            <li>Everything in Basic</li>
            <li>Analyzer + Strategy Builder</li>
            <li>Voice summaries & Alexa directions</li>
          </ul>
          <a class="btn purple" href="https://buy.stripe.com/3cI7sLfiJ33efHDdcO38400">Start 3-Day Free</a>
        </div>
        <div class="card" style="min-width:260px;border-color:#22c55e">
          <h4>Lifetime — $999 one-time</h4>
          <ul class="mut">
            <li>All Pro features forever</li>
            <li>Future strategy packs included</li>
          </ul>
          <a class="btn" href="https://buy.stripe.com/bJe00jfiJ7ju3YVdcO38406">Start 3-Day Free</a>
        </div>
      </div>
    </section>

    <footer>© <span id="year"></span> TrueTrend AI</footer>
  </div>

  <!-- Strategies / How-to Modal -->
  <div class="modal" id="guide">
    <div class="sheet">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h3 id="strategies" style="margin:0">Strategies & How-To</h3>
        <button class="btn ghost" id="closeGuide">Close</button>
      </div>
      <div class="divider"></div>
      <h4>Built-in strategies</h4>
      <ul class="mut">
        <li><b>Trendline (short-term):</b> EMA slope proxy + pullback confirm.</li>
        <li><b>Crossing EMAs (swing):</b> EMA-9 crossing EMA-50 + volume thrust.</li>
        <li><b>RSI Reversal (short-term):</b> RSI(14) crosses 30/70 with momentum.</li>
        <li><b>Range Breakout (any):</b> break of recent high/low with retest.</li>
        <li><b>Multi-TF filter:</b> optional “higher timeframe” slope check.</li>
      </ul>

      <div class="divider"></div>
      <h4>Alexa voice hookup (Pro/Lifetime)</h4>
      <ol class="mut">
        <li>In the TrueTrend app, enable Voice in Settings.</li>
        <li>In Alexa app, add a Custom Skill: Invocation “TrueTrend”.</li>
        <li>Sample phrase: “Alexa, ask TrueTrend what’s the direction on NVDA?”</li>
        <li>We return bias, confidence, RSI and key levels; Alexa reads it.</li>
      </ol>

      <div class="divider"></div>
      <h4>How to run the analyzer</h4>
      <ol class="mut">
        <li>Pick <b>Ticker</b> → choose <b>Timeframe</b> → choose <b>Strategy</b>.</li>
        <li>Click <b>Analyze</b>. If Pro/Lifetime, you’ll get voice and full signals.</li>
        <li>Click “Add” in Journal to record the trade; we’ll draw your equity curve.</li>
      </ol>
    </div>
  </div>

<script>
const $ = sel => document.querySelector(sel);
const $$ = sel => document.querySelectorAll(sel);

// ----- plan gate -----
async function getPlan(){
  try{
    const r=await fetch('/api/entitlements/whoami',{credentials:'include'});
    if(!r.ok) throw 0;
    const j=await r.json(); return j.plan||'basic';
  }catch{return 'basic'}
}
async function applyGate(){
  const p = await getPlan();
  $('#planBadge').textContent = p==='pro' ? 'Pro' : p==='lifetime' ? 'Lifetime' : 'Basic';
  const hasFull = (p==='pro'||p==='lifetime'||p==='family');
  if(!hasFull){
    // lock the pro panel & voice lookup
    const lock = '<div class="lockOverlay"><div class="lockInner"><b>Pro/Lifetime required</b><div style="margin-top:8px"><a class="btn purple" href="#pricing">Start 3-Day Free</a></div></div></div>';
    if(!$('#proPanel').querySelector('.lockOverlay')) $('#proPanel').insertAdjacentHTML('beforeend',lock);
  } else {
    $('#voiceRow').style.display='flex';
  }
}
applyGate();

// ----- strategies modal -----
$('#openGuide').onclick = $('#openStrategies').onclick = ()=>{$('#guide').style.display='flex'}
$('#closeGuide').onclick = ()=>{$('#guide').style.display='none'}

// ----- analyze -----
const clicks=[];
function recordClick(){
  const now=Date.now();
  clicks.push(now);
  // keep last hour
  while(clicks[0] < now-60*60*1000) clicks.shift();
  const last15 = clicks.filter(t=> t>now-15*60*1000).length;
  const last60 = clicks.length;
  $('#otLabel').textContent = last15>10 || last60>25 ? 'Slow down' : 'Cool';
}

$('#run').onclick = async ()=>{
  recordClick();
  const symbol = $('#symbol').value.trim() || 'NVDA';
  const timeframe = $('#timeframe').value;
  const strategy = $('#strategy').value;
  $('#answer').textContent = 'Analyzing '+symbol+'…';
  try{
    const r = await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},
      body: JSON.stringify({symbol,timeframe,strategy})});
    const j = await r.json();
    if(j.error){ $('#answer').textContent = 'Error: '+j.message; return; }

    // pretty print
    const lines = [];
    lines.push(`Symbol: ${symbol} (${timeframe})`);
    lines.push(`Price: ${j.quote.c.toFixed(2)}   High: ${j.quote.h.toFixed(2)}   Low: ${j.quote.l.toFixed(2)}`);
    lines.push(`Signal: ${j.signal.action}   Confidence: ${Math.round(j.signal.confidence)}%`);
    if(j.targets) lines.push(`Entry: ${j.targets.entry?.toFixed?.(2) ?? '-'}   Stop: ${j.targets.stop?.toFixed?.(2) ?? '-'}   TP: ${j.targets.tp?.toFixed?.(2) ?? '-'}`);
    lines.push('— Reasoning —');
    j.signal.reasons.forEach(r=>lines.push('• '+r));
    $('#answer').textContent = lines.join('\\n');

    // notification
    if(Notification && Notification.permission!=='denied'){
      if(Notification.permission!=='granted') await Notification.requestPermission();
      if(Notification.permission==='granted'){
        new Notification(`TrueTrend: ${j.signal.action}`, { body:`${symbol} ${timeframe} · ${Math.round(j.signal.confidence)}%` });
      }
    }

    // voice (gated)
    $('#speakBtn').onclick = ()=> speak(j.voiceText || lines.join('. '));
  }catch(e){
    $('#answer').textContent = 'Network error.';
  }
};

// ----- voice synthesis (friendlier male if available) -----
function pickMaleVoice(){
  const voices = speechSynthesis.getVoices();
  const prefer = [
    /Daniel/i, /Alex/i, /UK English Male/i, /Google UK English Male/i, /Male/i
  ];
  for(const p of prefer){
    const v = voices.find(v=>p.test(v.name)); if(v) return v;
  }
  return voices[0];
}
function speak(text){
  if(!window.speechSynthesis) return;
  const u = new SpeechSynthesisUtterance(text);
  const v = pickMaleVoice(); if(v) u.voice = v;
  u.rate = 1.02; u.pitch = 1.05;
  speechSynthesis.cancel(); speechSynthesis.speak(u);
}
speechSynthesis.onvoiceschanged = ()=>{}; // ensures voices load

// ----- voice lookup short-cut -----
$('#voiceAnalyze').onclick = async ()=>{
  const s = $('#voiceSym').value.trim() || 'AAPL';
  $('#voiceOut').textContent = 'Fetching voice text for '+s+'…';
  const r = await fetch('/api/analyze',{method:'POST',headers:{'Content-Type':'application/json'},
    body: JSON.stringify({symbol:s,timeframe:'Daily',strategy:'trendline'})});
  const j = await r.json();
  $('#voiceOut').textContent = j.voiceText || '—';
  if($('#voiceRow').style.display==='flex') speak(j.voiceText);
};

// ----- journal -----
const storeKey='tt_journal_v1';
let journal = JSON.parse(localStorage.getItem(storeKey)||'[]');
function renderJournal(){
  const tb = $('#jTable tbody'); tb.innerHTML='';
  let eq = 0; const pts=[0];
  journal.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML = \`<td>\${new Date(row.ts).toLocaleString()}</td>
      <td>\${row.sym}</td><td align="center">\${row.side}</td>
      <td align="right">\${(+row.entry).toFixed(4)}</td>
      <td align="right">\${(+row.exit).toFixed(4)}</td>
      <td align="right" class="mono">\${(row.pnl).toFixed(2)}</td>
      <td>\${row.notes||''}</td>\`;
    tb.appendChild(tr);
    eq += row.pnl; pts.push(eq);
  });
  drawEquity(pts);
}
function drawEquity(pts){
  const c=$('#equity'); const ctx=c.getContext('2d');
  const w=c.width=c.clientWidth; const h=c.height;
  ctx.clearRect(0,0,w,h);
  if(pts.length<2) return;
  const max=Math.max(...pts), min=Math.min(...pts);
  const range = max-min||1;
  ctx.strokeStyle='#7c5cff'; ctx.lineWidth=2; ctx.beginPath();
  pts.forEach((v,i)=>{
    const x = i/(pts.length-1)*w;
    const y = h - ((v-min)/range)*h;
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();
}
$('#addJ').onclick = ()=>{
  const sym=$('#jSym').value.trim()||'—';
  const entry=parseFloat($('#jEntry').value||'0');
  const exit=parseFloat($('#jExit').value||'0');
  const side=$('#jSide').value;
  const notes=$('#jNotes').value.trim();
  if(!entry||!exit){ alert('Entry & Exit required'); return; }
  const pnl = (side==='BUY') ? (exit-entry) : (entry-exit);
  journal.push({ts:Date.now(),sym,entry,exit,side,notes,pnl});
  localStorage.setItem(storeKey,JSON.stringify(journal));
  renderJournal();
};
renderJournal();

$('#year').textContent = new Date().getFullYear();
</script>
</body>
</html>
